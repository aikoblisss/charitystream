<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Charity Stream - Watch Ads for Good Causes</title>
  
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  
  <style>
    /* Reset and base styles */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-feature-settings: 'liga' 1, 'calt' 1, 'tnum' 1;
      background-color: white;
      color: #111827;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Brand colors */
    :root {
      --brand-500: #3f9d5e;
      --brand-600: #2f7a48;
      --brand-700: #26623a;
      --gray-50: #f9fafb;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    /* Header */
    .header {
      border-bottom: 1px solid var(--gray-200);
    }

    .header .container {
      height: 4rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.025em;
      margin-left: -4px;
    }

    .nav {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .nav-hidden-mobile {
      display: none;
      align-items: center;
      gap: 1.5rem;
    }

    .welcome {
      color: var(--gray-900);
    }

    .welcome-bold {
      font-weight: 500;
    }

    .nav-link {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .nav-link:hover {
      color: var(--gray-900);
    }

    .watch-ads-btn, .login-btn {
      display: inline-flex;
      align-items: center;
      background: none;
      color: var(--gray-700);
      padding: 0.5rem 0;
      border: none;
      border-radius: 0;
      font-weight: 400;
      text-decoration: none;
      cursor: pointer;
    }

    .watch-ads-btn:hover, .login-btn:hover {
      color: var(--gray-900);
    }

    .watch-ads-btn.active, .login-btn.active {
      color: var(--brand-600);
      font-weight: 600;
    }

    .user-menu {
      position: relative;
    }

    .user-menu-btn {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .user-menu-btn:hover {
      color: var(--gray-900);
    }

    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      padding: 0.5rem 0;
      min-width: 120px;
      z-index: 1000;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      width: 100%;
      text-align: left;
    }

    .logout-btn:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    /* Hero section */
    .hero {
      border-bottom: 1px solid var(--gray-200);
    }

    .hero-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      text-align: center;
    }

    .hero-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .hero-amount {
      margin-top: 0.25rem;
      font-size: 3rem;
      font-weight: 800;
      color: var(--brand-600);
      letter-spacing: -0.025em;
      font-variant-numeric: tabular-nums;
    }

    .hero-subtitle {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    /* Main content */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      align-items: stretch;
    }

    /* Video section */
    .video-section {
      display: flex;
      flex-direction: column;
    }

    .video-container {
      position: relative;
      flex: 1;
      overflow: hidden;
      border-radius: 0.75rem 0.75rem 0 0;
      border: 1px solid var(--gray-200);
      background-color: #000;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }

    /* Video.js player styling */
    .video-js {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      border-radius: 0.75rem 0.75rem 0 0;
      background-color: #000;
      object-fit: cover;
    }

    .video-js .vjs-tech {
      border-radius: 0.75rem 0.75rem 0 0;
      object-fit: cover;
      width: 100% !important;
      height: 100% !important;
    }

    .video-js .vjs-big-play-button {
      width: 5rem;
      height: 5rem;
      background-color: var(--brand-600);
      border: none;
      border-radius: 50%;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
    }

    .video-js .vjs-big-play-button:hover {
      background-color: var(--brand-700);
    }

    .video-js .vjs-big-play-button .vjs-icon-placeholder {
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      position: relative;
    }

    .video-js .vjs-big-play-button .vjs-icon-placeholder::before {
      content: "â–¶";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateY(4mm) translateX(1mm);
      font-size: 2.5rem;
      line-height: 1;
      margin: 0;
      padding: 0;
    }

    /* Hide time displays */
    .video-js .vjs-current-time,
    .video-js .vjs-duration,
    .video-js .vjs-time-control,
    .video-js .vjs-remaining-time {
      display: none !important;
    }

    .login-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 0.75rem 0.75rem 0 0;
      z-index: 10;
    }

    .login-prompt {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 300px;
    }

    .login-prompt h3 {
      margin-bottom: 1rem;
      color: var(--gray-900);
    }

    .login-prompt p {
      margin-bottom: 1.5rem;
      color: var(--gray-600);
      font-size: 0.875rem;
    }

    .video-controls {
      border-left: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-200);
      border-bottom: 1px solid var(--gray-200);
      border-radius: 0 0 0.75rem 0.75rem;
      background-color: white;
      padding: 0.75rem 1rem;
      box-shadow: 0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 0;
    }

    .quality-text {
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .quality-number {
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .upgrade-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--brand-600);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      font-variant-numeric: tabular-nums;
    }

    .upgrade-btn:hover {
      background-color: var(--brand-700);
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .card {
      flex: 1;
      border-radius: 0.75rem;
      border: 1px solid var(--gray-200);
      background-color: white;
      box-shadow: 0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.1);
    }

    .card-content {
      padding: 1.25rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
    }

    /* Impact metrics */
    .metrics {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      font-size: 0.875rem;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
    }

    .metric-label {
      color: var(--gray-600);
    }

    .metric-value {
      font-weight: 600;
      color: var(--brand-600);
      font-variant-numeric: tabular-nums;
    }

    /* Leaderboard */
    .leaderboard {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--gray-50);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .leaderboard-item.current-user {
      border: 1px solid rgba(63, 157, 94, 0.4);
      background-color: white;
    }

    .leaderboard-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .rank {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      font-variant-numeric: tabular-nums;
    }

    .rank.current-user {
      color: var(--brand-600);
    }

    .username {
      font-size: 0.875rem;
      color: var(--gray-800);
    }

    .username.current-user {
      font-weight: 500;
      color: var(--brand-700);
    }

    .minutes {
      font-size: 0.875rem;
      color: var(--gray-700);
      font-variant-numeric: tabular-nums;
    }

    .minutes.current-user {
      color: var(--brand-700);
    }

    .loading {
      display: none;
      margin-top: 10px;
      color: #aaa;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .hero-amount {
        font-size: 2.5rem;
      }
    }

    @media (max-width: 768px) {
      .header .container {
        padding: 0 1rem;
      }
      
      .hero-container, .main {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .nav-hidden-mobile {
        display: none;
      }
    }

    @media (min-width: 640px) {
      .hero-amount {
        font-size: 3.75rem;
      }
      
      .hero-container, .main {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
    }

    @media (min-width: 1024px) {
      .hero-container, .main {
        padding-left: 2rem;
        padding-right: 2rem;
      }
      
      .upgrade-btn {
        padding: 0.5rem 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Top Nav -->
  <header class="header">
    <div class="container">
      <div class="logo">Charity Stream</div>
      <nav class="nav">
        <div class="nav-hidden-mobile" id="loggedInNav" style="display: none;">
          <a href="#" class="nav-link" onclick="handleNavClick('about')">About</a>
          <a href="#" class="nav-link" onclick="handleNavClick('advertise')">Advertise</a>
          <a href="#" class="nav-link" onclick="handleNavClick('impact')">Impact</a>
          <a href="#" class="nav-link active" onclick="handleNavClick('watch')">Watch Ads</a>
          <div class="user-menu">
            <button class="user-menu-btn" onclick="toggleUserMenu()" id="userMenuBtn">
              <span id="usernameDisplay">User</span> â–¼
            </button>
            <div class="user-dropdown" id="userDropdown" style="display: none;">
              <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
          </div>
        </div>
        <div class="nav-hidden-mobile" id="guestNav">
          <a href="#" class="nav-link" onclick="handleGuestNavClick('about')">About</a>
          <a href="#" class="nav-link" onclick="handleGuestNavClick('advertise')">Advertise</a>
          <a href="#" class="nav-link" onclick="handleGuestNavClick('impact')">Impact</a>
          <a href="#" class="nav-link" onclick="handleGuestNavClick('watch')">Watch Ads</a>
          <a href="#" class="nav-link" onclick="goToAuth()">Sign In / Sign Up</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- Hero / Total Raised -->
  <section class="hero">
    <div class="hero-container">
      <h1 class="hero-title">Total Raised for Charity</h1>
      <div class="hero-amount">$832.11</div>
      <p class="hero-subtitle">Stream ads, fuel impact, compete for good.</p>
    </div>
  </section>

  <!-- Main Content -->
  <main class="main">
    <div class="grid">
      <!-- Video Area -->
      <section class="video-section">
        <div class="video-container">
          <video
            id="my-video"
            class="video-js vjs-default-skin"
            controls
            preload="auto"
            data-setup="{}"
          >
            <source src="videos/video1_1080p.mp4" type="video/mp4" />
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider upgrading to a
              web browser that supports HTML5 video.
            </p>
          </video>
          
          <!-- Login overlay for non-authenticated users -->
          <div class="login-overlay" id="loginOverlay">
            <div class="login-prompt">
              <h3>Sign In Required</h3>
              <p>Please sign in to start watching ads for charity and track your impact!</p>
              <button class="watch-ads-btn" onclick="goToAuth()">Sign In / Sign Up</button>
            </div>
          </div>
        </div>
        <div class="video-controls">
          <div class="quality-text">Quality: <span class="quality-number" id="currentQualityDisplay">1080p</span></div>
          <button class="upgrade-btn">Upgrade to Premium for $3/month</button>
        </div>
      </section>

      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Your Impact Card -->
        <div class="card">
          <div class="card-content">
            <h2 class="card-title">Your Impact</h2>
            <dl class="metrics">
              <div class="metric-row">
                <dt class="metric-label">Ads Watched Today</dt>
                <dd class="metric-value" id="adsWatchedToday">0</dd>
              </div>
              <div class="metric-row">
                <dt class="metric-label">Total Ads Watched</dt>
                <dd class="metric-value" id="totalAdsWatched">0</dd>
              </div>
              <div class="metric-row">
                <dt class="metric-label">Current Rank</dt>
                <dd class="metric-value" id="currentRank">#-</dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- Leaderboard Card -->
        <div class="card">
          <div class="card-content">
            <h2 class="card-title">Top Ad Watchers This Month</h2>
            <ul class="leaderboard">
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#1</span>
                  <span class="username">Branden4Good</span>
                </div>
                <span class="minutes">2,517 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#2</span>
                  <span class="username">HiMom11</span>
                </div>
                <span class="minutes">2,142 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#3</span>
                  <span class="username">AdsAreAwesome</span>
                </div>
                <span class="minutes">1,894 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#4</span>
                  <span class="username">Payit4Ward</span>
                </div>
                <span class="minutes">1,563 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#5</span>
                  <span class="username">DrakeFan32</span>
                </div>
                <span class="minutes">1,244 mins</span>
              </li>
              <li class="leaderboard-item current-user" id="currentUserRow" style="display: none;">
                <div class="leaderboard-left">
                  <span class="rank current-user" id="userRankDisplay">#53</span>
                  <span class="username current-user"><span id="userLeaderboardName">You</span> (You)</span>
                </div>
                <span class="minutes current-user" id="userMinutesDisplay">0 mins</span>
              </li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <div class="loading" id="loadingIndicator">Loading...</div>

  <!-- Video.js -->
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  
  <!-- Custom scripts -->
  <script src="script.js"></script>
  
  <script>
    // Authentication and user management
    let currentUser = null;
    let authToken = null;
    let currentSessionId = null;
    let player = null;

    // Check authentication immediately when script loads
    authToken = localStorage.getItem('authToken');
    const userStr = localStorage.getItem('currentUser');
    
    if (authToken && userStr) {
      try {
        currentUser = JSON.parse(userStr);
        console.log('ðŸ‘¤ Pre-loaded user data:', currentUser);
      } catch (error) {
        console.error('âŒ Error parsing cached user data:', error);
      }
    }

    // Set initial UI state immediately to prevent flash
    function setInitialUIState() {
      if (authToken) {
        document.getElementById('loggedInNav').style.display = 'flex';
        document.getElementById('guestNav').style.display = 'none';
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('currentUserRow').style.display = 'flex';
        
        if (currentUser) {
          const displayName = currentUser.username || currentUser.email?.split('@')[0] || 'User';
          document.getElementById('usernameDisplay').textContent = displayName;
          document.getElementById('userLeaderboardName').textContent = displayName;
        }
      } else {
        document.getElementById('loggedInNav').style.display = 'none';
        document.getElementById('guestNav').style.display = 'flex';
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('currentUserRow').style.display = 'none';
      }
    }

    // Call immediately when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setInitialUIState);
    } else {
      setInitialUIState();
    }

    // Check authentication on page load
    window.onload = function() {
      console.log('ðŸš€ Page loading, checking authentication...');
      
      // Check for token from URL parameters (Google OAuth callback)
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      
      if (tokenFromUrl) {
        console.log('ðŸ”‘ Token found in URL, storing in localStorage');
        localStorage.setItem('authToken', tokenFromUrl);
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      authToken = localStorage.getItem('authToken');
      const userStr = localStorage.getItem('currentUser');
      
      console.log('ðŸ” Auth check:', {
        hasToken: !!authToken,
        hasUser: !!userStr,
        token: authToken ? 'Present' : 'Missing'
      });
      
      // UI state is already set by setInitialUIState(), just handle video initialization
      if (authToken) {
        console.log('âœ… User has token, initializing authenticated video player...');
        
        // Load fresh user info from server, then initialize video player
        loadUserInfo().then(() => {
          // Give more time for Video.js to load before initializing
          setTimeout(initializeVideoPlayer, 500);
        });
      } else {
        console.log('âŒ No token found, initializing guest video player');
        setTimeout(initializeVideoPlayerForGuests, 500);
      }
    };

    function showAuthenticatedUI() {
      document.getElementById('loggedInNav').style.display = 'flex';
      document.getElementById('guestNav').style.display = 'none';
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('currentUserRow').style.display = 'flex';
      
      // Username will be set by loadUserInfo() after it completes
      document.getElementById('usernameDisplay').textContent = 'Loading...';
      document.getElementById('userLeaderboardName').textContent = 'Loading...';
    }

    function showUnauthenticatedUI() {
      document.getElementById('loggedInNav').style.display = 'none';
      document.getElementById('guestNav').style.display = 'flex';
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('currentUserRow').style.display = 'none';
    }

    function goToAuth() {
      window.location.href = '/auth.html';
    }

    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      authToken = null;
      currentUser = null;
      showUnauthenticatedUI();
      
      // Reinitialize video player for guests
      if (player) {
        player.dispose();
        player = null;
      }
      setTimeout(initializeVideoPlayerForGuests, 100);
    }

    function handleNavClick(action) {
      const token = localStorage.getItem('authToken');
      
      if (!token) {
        // Redirect to login if not authenticated
        window.location.href = '/auth.html';
        return;
      }

      switch (action) {
        case 'about':
          window.location.href = '/about.html';
          break;
        case 'advertise':
          window.location.href = '/advertiser.html';
          break;
        case 'impact':
          window.location.href = '/impact.html';
          break;
        case 'watch':
          // Already on main page
          break;
      }
    }

    function handleGuestNavClick(action) {
      switch (action) {
        case 'about':
          window.location.href = '/about.html';
          break;
        case 'advertise':
          window.location.href = '/advertiser.html';
          break;
        case 'impact':
          alert('Please sign in to view your impact and leaderboards!');
          break;
        case 'watch':
          alert('Please sign in to watch ads and start making a difference!');
          break;
      }
    }

    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const userMenu = document.querySelector('.user-menu');
      const dropdown = document.getElementById('userDropdown');
      
      if (userMenu && !userMenu.contains(event.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Load fresh user info from server
    async function loadUserInfo() {
      try {
        console.log('ðŸ“¡ Loading user info with token:', authToken ? 'Present' : 'Missing');
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        console.log('ðŸ“¡ User info response status:', response.status);
        if (response.ok) {
          const result = await response.json();
          console.log('ðŸ‘¤ User info received:', result);
          currentUser = result.user;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Update UI with user data
          const displayName = currentUser.username || currentUser.email?.split('@')[0] || 'User';
          document.getElementById('usernameDisplay').textContent = displayName;
          document.getElementById('userLeaderboardName').textContent = displayName;
          document.getElementById('totalAdsWatched').textContent = currentUser.totalMinutesWatched || 0;
          document.getElementById('userMinutesDisplay').textContent = (currentUser.currentMonthMinutes || 0) + ' mins';
          
          // Get user's rank
          const rankResponse = await fetch('/api/leaderboard/my-rank', {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          
          if (rankResponse.ok) {
            const rankResult = await rankResponse.json();
            document.getElementById('currentRank').textContent = `#${rankResult.rank}`;
            document.getElementById('userRankDisplay').textContent = `#${rankResult.rank}`;
          }
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    // Initialize video player for guests (no functionality)
    function initializeVideoPlayerForGuests() {
      // Dispose any existing player
      if (player) {
        player.dispose();
        player = null;
      }
      
      // Wait for Video.js to be available
      if (typeof videojs === 'undefined') {
        setTimeout(initializeVideoPlayerForGuests, 100);
        return;
      }
      
      try {
        player = videojs('my-video', {
          controls: false,
          autoplay: false,
          preload: 'none',
          fluid: true
        });

        // Intercept play attempts and show login
        player.on('play', function(e) {
          e.preventDefault();
          player.pause();
          document.getElementById('loginOverlay').style.display = 'flex';
          return false;
        });

        // Also intercept the big play button click
        player.on('loadstart', function() {
          const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
          if (bigPlayButton) {
            bigPlayButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              document.getElementById('loginOverlay').style.display = 'flex';
              return false;
            });
          }
        });
        
        console.log('Guest video player initialized');
      } catch (error) {
        console.error('Error initializing guest video player:', error);
      }
    }

    // Start a watch session
    async function startWatchSession(videoName, quality) {
      if (!authToken) return null;

      try {
        const response = await fetch('/api/tracking/start-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            videoName: videoName,
            quality: quality
          })
        });

        if (response.ok) {
          const result = await response.json();
          currentSessionId = result.sessionId;
          console.log('ðŸ“º Watch session started:', result.sessionId);
          return result.sessionId;
        }
      } catch (error) {
        console.error('Error starting watch session:', error);
      }
      return null;
    }

    // Complete a watch session
    async function completeWatchSession(sessionId, durationSeconds, completed, pausedCount = 0) {
      if (!authToken || !sessionId) return;

      try {
        const response = await fetch('/api/tracking/complete-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            sessionId: sessionId,
            durationSeconds: durationSeconds,
            completed: completed,
            pausedCount: pausedCount
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('â±ï¸ Watch session completed:', result.minutesWatched, 'minutes');
          
          // Refresh user info to show updated watch time
          loadUserInfo();
        }
      } catch (error) {
        console.error('Error completing watch session:', error);
      }
    }

    // Initialize full video player functionality for authenticated users
    function initializeVideoPlayer() {
      if (!authToken) return;

      console.log('ðŸŽ¬ Initializing authenticated video player...');

      // Dispose existing player if any
      if (player) {
        player.dispose();
        player = null;
      }
      
      // Wait for Video.js to be available
      if (typeof videojs === 'undefined') {
        setTimeout(initializeVideoPlayer, 100);
        return;
      }
      
      try {
        player = videojs('my-video', {
          controls: true,
          autoplay: false,
          preload: 'auto',
          fluid: true,
          controlBar: {
            progressControl: false,
            fullscreenToggle: false,
            pictureInPictureToggle: false,
            currentTimeDisplay: false,
            timeDivider: false,
            durationDisplay: false,
            remainingTimeDisplay: false
          }
        });

        const loadingIndicator = document.getElementById("loadingIndicator");
        const playlist = ["video1", "video2", "video3"];
        let currentIndex = 0;
        let currentQuality = "1080p";
        let isQualitySwitching = false;
        let sessionStartTime = null;
        let pausedCount = 0;
        let currentVideoStartTime = null;
        let isInitialLoad = true;
        let isPlaying = false;

        function getVideoUrl(videoName, quality) {
          return `videos/${videoName}_${quality}.mp4`;
        }

        function getCurrentVideoSource() {
          const videoName = playlist[currentIndex];
          return {
            src: getVideoUrl(videoName, currentQuality),
            type: "video/mp4"
          };
        }

        function updateQualityDisplay() {
          document.getElementById('currentQualityDisplay').textContent = currentQuality;
        }

        function loadVideoWithQuality(index) {
          if (index >= playlist.length) return;
          
          currentIndex = index;
          const source = getCurrentVideoSource();
          console.log(`Loading video ${index + 1}: ${source.src}`);
          
          // Add error handling for video loading
          player.src(source);
          updateQualityDisplay();
          
          // Set a timeout to check if video loaded successfully
          const loadTimeout = setTimeout(() => {
            if (player.readyState() === 0) {
              console.warn('Video failed to load, trying next video...');
              loadVideoWithQuality((index + 1) % playlist.length);
            }
          }, 5000);
          
          player.one('loadeddata', () => {
            clearTimeout(loadTimeout);
            console.log('Video loaded successfully');
            
            // Auto-play on initial load
            if (isInitialLoad) {
              setTimeout(() => {
                player.play().catch(error => {
                  console.log('Initial auto-play prevented:', error);
                });
                isInitialLoad = false;
              }, 200);
            }
          });
          
          if (typeof startWatchSession === 'function') {
            startWatchSession(playlist[currentIndex], currentQuality).then(sessionId => {
              if (sessionId) {
                currentSessionId = sessionId;
                currentVideoStartTime = Date.now();
                sessionStartTime = null;
                pausedCount = 0;
              }
            });
          }
        }

        function disableDoubleClickFullscreen() {
          player.off('dblclick');
          const videoEl = player.el();
          const preventDoubleClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
          };
          videoEl.addEventListener('dblclick', preventDoubleClick, true);
          videoEl.addEventListener('contextmenu', preventDoubleClick);
          player.requestFullscreen = function() {
            console.log('Fullscreen disabled');
            return Promise.resolve();
          };
        }

        player.on('play', () => {
          isPlaying = true;
          
          if (!sessionStartTime && currentSessionId) {
            sessionStartTime = Date.now();
            console.log('â–¶ï¸ Video started playing, tracking begins');
          }
          
          // Hide the big play button when playing (with slight delay to avoid interference)
          setTimeout(() => {
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton && isPlaying) {
              bigPlayButton.style.display = 'none';
            }
          }, 50);
        });

        player.on('pause', () => {
          isPlaying = false;
          pausedCount++;
          console.log('â¸ï¸ Video paused, pause count:', pausedCount);
          
          // Show the big play button when paused (with slight delay for smoothness)
          setTimeout(() => {
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton && !isPlaying) {
              bigPlayButton.style.display = 'flex';
            }
          }, 50);
        });

        player.on("ended", function () {
          if (!isQualitySwitching && currentSessionId && currentVideoStartTime) {
            const durationSeconds = Math.floor((Date.now() - currentVideoStartTime) / 1000);
            if (typeof completeWatchSession === 'function') {
              completeWatchSession(currentSessionId, durationSeconds, true, pausedCount);
            }
            
            currentVideoStartTime = null;
            sessionStartTime = null;
            pausedCount = 0;
            currentSessionId = null;
          }
          
          if (!isQualitySwitching) {
            console.log(`Video ${currentIndex + 1} ended, loading next video...`);
            currentIndex = (currentIndex + 1) % playlist.length;
            loadVideoWithQuality(currentIndex);
            
            player.one('loadeddata', () => {
              console.log('Next video loaded, starting playback');
              
              // Small delay to ensure video is ready, then auto-play
              setTimeout(() => {
                player.play().catch(error => {
                  console.log('Auto-play prevented:', error);
                });
              }, 200);
            });
          }
        });

        player.on("waiting", () => {
          if (!isQualitySwitching) {
            loadingIndicator.style.display = "block";
          }
        });

        player.on("playing", () => {
          loadingIndicator.style.display = "none";
        });

        player.on("error", function() {
          const error = player.error();
          console.error('Video error:', error);
          console.error('Current video should be:', getCurrentVideoSource().src);
          loadingIndicator.style.display = "none";
        });

        player.ready(function() {
          console.log('=== AUTHENTICATED VIDEO PLAYER LOADED ===');
          disableDoubleClickFullscreen();
          
          // Ensure smooth play button behavior
          const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
          if (bigPlayButton) {
            bigPlayButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              // Ensure smooth playback
              setTimeout(() => {
                player.play().catch(error => {
                  console.log('Play button click prevented:', error);
                });
              }, 10);
            });
          }

          const progress = player.controlBar.progressControl;
          if (progress) progress.el().style.display = "none";
          const fullscreenBtn = player.controlBar.fullscreenToggle;
          if (fullscreenBtn) fullscreenBtn.el().style.display = "none";
          const pipBtn = player.controlBar.pictureInPictureToggle;
          if (pipBtn) pipBtn.el().style.display = "none";
          
          // Hide time displays
          const currentTimeDisplay = player.controlBar.currentTimeDisplay;
          if (currentTimeDisplay) currentTimeDisplay.el().style.display = "none";
          const durationDisplay = player.controlBar.durationDisplay;
          if (durationDisplay) durationDisplay.el().style.display = "none";
          const remainingTimeDisplay = player.controlBar.remainingTimeDisplay;
          if (remainingTimeDisplay) remainingTimeDisplay.el().style.display = "none";
          const timeDivider = player.controlBar.timeDivider;
          if (timeDivider) timeDivider.el().style.display = "none";

          // Add error handling for video loading
          player.on('loadstart', function() {
            console.log('Video loading started');
          });

          player.on('loadedmetadata', function() {
            console.log('Video metadata loaded');
          });

          player.on('loadeddata', function() {
            console.log('Video data loaded');
          });

          setTimeout(() => {
            console.log('Video player fully initialized');
            loadVideoWithQuality(0);
            
            // Ensure play button is visible initially
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton) {
              bigPlayButton.style.display = 'flex';
            }
          }, 500);
        });

        console.log('Authenticated video player initialization complete!');
      } catch (error) {
        console.error('Error initializing authenticated video player:', error);
      }
    }
  </script>
</body>
</html>