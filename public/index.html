<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Charity Stream - Watch Ads for Good Causes</title>
  
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  
  <style>
    /* Reset and base styles */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-feature-settings: 'liga' 1, 'calt' 1, 'tnum' 1;
      background-color: white;
      color: #111827;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
    }

    /* Brand colors */
    :root {
      --brand-500: #2F7D31;
      --brand-600: #2F7D31;
      --brand-700: #276629;
      --fora-bg: #E9FFE9;
      --gray-50: #f9fafb;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    /* Header */
    .header {
      border-bottom: 1px solid var(--gray-200);
    }

    .header-container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 0 1rem;
      height: 4rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.025em;
      color: inherit;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s;
    }

    .logo:hover {
      color: var(--brand-600);
    }

    .nav {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      font-size: 0.9375rem;
      color: var(--gray-700);
    }

    .nav-hidden-mobile {
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    .welcome {
      color: var(--gray-900);
    }

    .welcome-bold {
      font-weight: 500;
    }

    .nav-link {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .nav-link:hover {
      color: var(--gray-900);
    }

    .watch-ads-btn {
      display: inline-flex;
      align-items: center;
      background-color: var(--brand-600);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
    }

    .watch-ads-btn:hover {
      background-color: var(--brand-700);
    }

    /* FORA Charity Header */
    .charity-header {
      background-color: var(--fora-bg);
      border-bottom: 1px solid var(--gray-200);
    }

    .charity-header-container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 0.75rem 1rem;
      text-align: center;
    }

    .charity-text {
      font-size: 0.9375rem;
      color: var(--gray-800);
    }

    .charity-highlight {
      font-weight: 600;
      color: var(--brand-600);
    }

    .user-menu {
      position: relative;
    }

    .user-menu-btn {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .user-menu-btn:hover {
      color: var(--gray-900);
    }

    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      padding: 0.5rem 0;
      min-width: 120px;
      z-index: 1000;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      width: 100%;
      text-align: left;
    }

    .logout-btn:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }

    /* Hero section */
    .hero {
      border-bottom: 1px solid var(--gray-200);
    }

    .hero-container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 1rem 1rem;
      text-align: center;
    }

    .hero-title { 
      font-size: 1.25rem; 
      font-weight: 600; 
      color: var(--gray-900); 
      margin-bottom: 0.125rem; 
    }

    .hero-amount { 
      margin-top: 0; 
      font-size: 3.875rem; 
      font-weight: 800; 
      color: var(--brand-600); 
      letter-spacing: -0.025em; 
      font-variant-numeric: tabular-nums; 
    }

    .hero-subtitle { 
      margin-top: 0.125rem; 
      font-size: 1.125rem; 
      color: var(--gray-600); 
    }

    /* Main content */
    .main {
      max-width: 1320px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.25rem;
      align-items: stretch;
      margin-bottom: 1.5rem;
    }

    /* Video section */
    .video-section {
      display: flex;
      flex-direction: column;
    }

    .video-container {
      position: relative;
      flex: 1;
      overflow: hidden;
      border-radius: 0.75rem 0.75rem 0 0;
      border: 1px solid var(--gray-200);
      background-color: var(--gray-200);
    }

    .video-aspect {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
    }

    .video-js {
      position: absolute !important;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
    }

    .video-js video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }

    /* Hide play button when video is playing */
    .video-js.vjs-playing .vjs-big-play-button {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* Show play button when video is paused */
    .video-js.vjs-paused .vjs-big-play-button {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }


    .video-js .vjs-tech {
      border-radius: 0.75rem 0.75rem 0 0;
      object-fit: cover;
      width: 100% !important;
      height: 100% !important;
    }

    .video-js .vjs-big-play-button {
      width: 5rem;
      height: 5rem;
      background-color: var(--brand-600);
      border: none;
      border-radius: 50%;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
    }

    .video-js .vjs-big-play-button:hover {
      background-color: var(--brand-700);
    }

    .video-js .vjs-big-play-button .vjs-icon-placeholder {
      font-size: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      position: relative;
    }

    .video-js .vjs-big-play-button .vjs-icon-placeholder::before {
      content: "â–¶";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) translateY(4mm) translateX(1mm);
      font-size: 2.5rem;
      line-height: 1;
      margin: 0;
      padding: 0;
    }

    /* Hide progress bar and other unwanted controls */
    .video-js .vjs-progress-control {
      display: none !important;
    }
    
    .video-js .vjs-progress-holder {
      display: none !important;
    }
    
    .video-js .vjs-load-progress {
      display: none !important;
    }
    
    .video-js .vjs-play-progress {
      display: none !important;
    }
    
    .video-js .vjs-time-tooltip {
      display: none !important;
    }
    
    .video-js .vjs-picture-in-picture-control {
      display: none !important;
    }
    
    .video-js .vjs-fullscreen-control {
      display: none !important;
    }

    /* Prevent unwanted interactions */
    .video-js, .video-js video {
      user-select: none !important;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-touch-callout: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }
    
    /* Disable drag and drop */
    .video-js video {
      pointer-events: none !important;
    }
    
    /* Re-enable pointer events for controls */
    .video-js .vjs-control-bar {
      pointer-events: auto !important;
    }
    
    .video-js .vjs-big-play-button {
      pointer-events: auto !important;
    }

    /* Hide time displays */
    .video-js .vjs-current-time,
    .video-js .vjs-duration,
    .video-js .vjs-time-control,
    .video-js .vjs-remaining-time {
      display: none !important;
    }

    .login-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 0.75rem 0.75rem 0 0;
      z-index: 10;
    }

    .login-prompt {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 300px;
    }

    .login-prompt h3 {
      margin-bottom: 1rem;
      color: var(--gray-900);
    }

    .login-prompt p {
      margin-bottom: 1.5rem;
      color: var(--gray-600);
      font-size: 0.875rem;
    }

    .video-controls {
      border-left: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-200);
      border-bottom: 1px solid var(--gray-200);
      border-radius: 0 0 0.75rem 0.75rem;
      background-color: white;
      padding: 0.75rem 1rem;
      box-shadow: 0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 0;
    }

    .quality-text {
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .quality-number {
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .upgrade-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--brand-600);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      font-variant-numeric: tabular-nums;
    }

    .upgrade-btn:hover {
      background-color: var(--brand-700);
    }

    .play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 5rem;
      height: 5rem;
      background-color: var(--brand-600);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .play-button:hover {
      background-color: var(--brand-700);
    }

    .play-icon {
      width: 2.5rem;
      height: 2.5rem;
      fill: white;
    }

    /* Progress bar section */
    .progress-section {
      border: 1px solid var(--gray-200);
      border-radius: 0.75rem;
      background-color: white;
      box-shadow: 0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.1);
    }

    .progress-content {
      padding: 0.75rem 0;
      margin: 0 0.25rem 0 -1rem;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .partner-text {
      font-size: 0.9375rem;
      color: var(--gray-700);
      font-weight: 600;
    }

    .progress-amount {
      font-size: 0.9375rem;
      color: var(--gray-700);
      font-variant-numeric: tabular-nums;
    }

    .amount-raised {
      font-weight: 600;
      color: var(--gray-900);
    }

    .amount-goal {
      font-weight: 600;
      color: var(--gray-900);
    }

    .amount-text {
      font-weight: 400;
      color: var(--gray-600);
    }

    .progress-bar-container {
      width: 100%;
      height: 0.5rem;
      background-color: var(--gray-200);
      border-radius: 0.25rem;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--brand-600);
      border-radius: 0.25rem;
      width: 70.4%; /* $352 of $500 */
      transition: width 0.3s ease;
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .card {
      flex: 1;
      border-radius: 0.75rem;
      border: 1px solid var(--gray-200);
      background-color: white;
      box-shadow: 0 1px 2px rgba(16,24,40,.04), 0 1px 3px rgba(16,24,40,.1);
    }

    .card-content {
      padding: 1.25rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
    }

    /* Impact metrics */
    .metrics {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      font-size: 0.875rem;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
    }

    .metric-label {
      color: var(--gray-600);
    }

    .metric-value {
      font-weight: 600;
      color: var(--brand-600);
      font-variant-numeric: tabular-nums;
    }

    /* Leaderboard */
    .leaderboard {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--gray-50);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .leaderboard-item.current-user {
      border: 1px solid rgba(63, 157, 94, 0.4);
      background-color: white;
    }

    .leaderboard-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .rank {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      font-variant-numeric: tabular-nums;
    }

    .rank.current-user {
      color: var(--brand-600);
    }

    .username {
      font-size: 0.875rem;
      color: var(--gray-800);
    }

    .username.current-user {
      font-weight: 500;
      color: var(--brand-700);
    }

    .minutes {
      font-size: 0.875rem;
      color: var(--gray-700);
      font-variant-numeric: tabular-nums;
    }

    .minutes.current-user {
      color: var(--brand-700);
    }

    .loading {
      display: none;
      margin-top: 10px;
      color: #aaa;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .hero-amount {
        font-size: 2.5rem;
      }
    }

    @media (max-width: 768px) {
      .header .container {
        padding: 0 1rem;
      }
      
      .hero-container, .main {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .nav-hidden-mobile {
        display: none;
      }
    }

    @media (min-width: 640px) {
      .hero-amount {
        font-size: 3.75rem;
      }
      
      .hero-container, .main {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
    }

    @media (min-width: 1024px) {
      .hero-container, .main {
        padding-left: 2rem;
        padding-right: 2rem;
      }
      
      .upgrade-btn {
        padding: 0.5rem 1.5rem;
      }
    }

    /* Lander Styles */
    .lander-hero {
      text-align: center;
      margin-top: 0px;
      margin-bottom: 15px;
    }
    
    .lander-title-section {
      padding: 2rem 1rem;
    }
    
    .lander-title {
      font-size: 56px;
      font-weight: 700;
      color: #111;
      line-height: 1.1;
      margin-bottom: 6px;
    }
    
    .lander-title .underline {
      text-decoration: underline;
      text-decoration-thickness: 4px;
      text-underline-offset: 8px;
    }
    
    .lander-subtitle {
      font-size: 56px;
      font-weight: 700;
      color: #111;
      line-height: 1.1;
    }
    
    .lander-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 1rem;
      min-height: 0;
      justify-content: center;
    }
    
    /* Lander Video Container */
    .lander-video-container {
      width: 100%;
      max-width: 1200px;
      height: 600px;
      background-color: #ddd;
      border-radius: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      margin-bottom: 20px;
      border: 3px solid transparent;
      transition: border-color 0.3s ease, transform 0.3s ease;
      cursor: pointer;
      text-decoration: none;
    }
    
    .lander-video-container:hover {
      border-color: #2F7D31;
      transform: scale(1.02);
    }
    
    .lander-play-button {
      width: 90px;
      height: 90px;
      background-color: #2F7D31;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 6px 20px rgba(47, 125, 49, 0.3);
    }
    
    .lander-video-container:hover .lander-play-button {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(47, 125, 49, 0.4);
    }
    
    .lander-play-button::before {
      content: '';
      width: 0;
      height: 0;
      border-left: 28px solid white;
      border-top: 16px solid transparent;
      border-bottom: 16px solid transparent;
      margin-left: 5px;
    }
    
    /* Lander Ticker Section */
    .lander-ticker-section {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 20px;
    }
    
    .lander-ticker-container {
      width: 100%;
      height: 50px;
      overflow: hidden;
      position: relative;
      margin-bottom: 8px;
      mask: linear-gradient(to right, 
          transparent 0%, 
          black 1%, 
          black 99%, 
          transparent 100%);
      -webkit-mask: linear-gradient(to right, 
          transparent 0%, 
          black 1%, 
          black 99%, 
          transparent 100%);
    }
    
    .lander-ticker-container:last-child {
      margin-bottom: 0;
    }
    
    .lander-ticker {
      display: flex;
      align-items: center;
      height: 100%;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      gap: 16px;
      width: 200%;
    }
    
    .lander-ticker-top {
      animation: scrollRightLoop 32s linear infinite;
    }
    
    .lander-ticker-bottom {
      animation: scrollLeftLoop 34s linear infinite;
    }
    
    .lander-ticker-chip {
      background-color: #399B3C;
      color: white;
      padding: 10px 18px;
      border-radius: 25px;
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .lander-ticker-chip-bottom {
      background-color: #2F7D31;
    }
    
    @keyframes scrollRightLoop {
      0% {
          transform: translateX(0%);
      }
      100% {
          transform: translateX(-50%);
      }
    }
    
    @keyframes scrollLeftLoop {
      0% {
          transform: translateX(-50%);
      }
      100% {
          transform: translateX(0%);
      }
    }
    
    /* Responsive adjustments for lander */
    @media (max-width: 1200px) {
      .lander-title, .lander-subtitle {
        font-size: 56px;
      }
      
      .lander-video-container {
        height: 320px;
        max-width: 800px;
      }
    }
    
    @media (max-width: 768px) {
      .lander-title, .lander-subtitle {
        font-size: 42px;
      }
      
      .lander-video-container {
        height: 250px;
        margin-bottom: 40px;
      }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .hero-amount { 
        margin-top: 0; 
        font-size: 3.875rem; 
        font-weight: 800; 
        color: var(--brand-600); 
        letter-spacing: -0.025em; 
        font-variant-numeric: tabular-nums; 
      }
    }

    @media (max-width: 768px) {
      .header-container, .charity-header-container, .hero-container, .main {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      
      .nav-hidden-mobile {
        display: none;
      }
    }

    @media (min-width: 640px) {
      .hero-amount { 
        margin-top: 0; 
        font-size: 3.875rem; 
        font-weight: 800; 
        color: var(--brand-600); 
        letter-spacing: -0.025em; 
        font-variant-numeric: tabular-nums; 
      }
      
      .header-container, .charity-header-container, .hero-container, .main {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }

      .progress-section {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
    }

    @media (min-width: 1024px) {
      .header-container, .charity-header-container, .hero-container, .main {
        padding-left: 2rem;
        padding-right: 2rem;
      }

      .progress-section {
        padding-left: 2rem;
        padding-right: 2rem;
      }
      
      .upgrade-btn {
        padding: 0.5rem 1.5rem;
      }
    }
  
/* === Viewport Framing (Desktop 100% Zoom) === */
@media (min-width: 1024px) {
  html, body { height: 100%; }
  body { scroll-snap-type: y mandatory; }
  .frame-snap { scroll-snap-align: start; scroll-snap-stop: always; }
  .frame-scaler { position: relative; width: 100%; }
  .frame-inner { transform-origin: top center; }
}
    /* Pop-up Ad Styles */
    .popup-ad {
      position: fixed;
      width: 384px;
      height: 384px;
      background-color: #ffffff;
      border: 3px solid #2F7D31;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .popup-ad.show {
      display: flex;
    }

    .popup-close-btn {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 32px;
      height: 32px;
      background-color: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .popup-close-btn:hover {
      background-color: #b91c1c;
    }

    .popup-content {
      text-align: center;
      padding: 20px;
    }

    .popup-title {
      font-size: 24px;
      font-weight: 700;
      color: #2F7D31;
      margin-bottom: 20px;
    }

    .popup-timer {
      font-size: 48px;
      font-weight: 800;
      color: #dc2626;
      margin-bottom: 10px;
      font-variant-numeric: tabular-nums;
    }

    .popup-subtitle {
      font-size: 16px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Responsive popup */
    @media (max-width: 768px) {
      .popup-ad {
        width: 320px;
        height: 320px;
      }

      .popup-title {
        font-size: 20px;
      }

      .popup-timer {
        font-size: 40px;
      }
    }

    /* Tutorial System Styles */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10001;
      display: none;
    }

    .tutorial-overlay.active {
      display: block;
    }

    .tutorial-highlight {
      position: absolute;
      border: 3px solid #2F7D31;
      border-radius: 8px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px rgba(47, 125, 49, 0.8);
      z-index: 10002;
      transition: all 0.3s ease;
    }

    .tutorial-tooltip {
      position: absolute;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 300px;
      z-index: 10003;
      font-family: 'Inter', sans-serif;
    }

    .tutorial-tooltip::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border: 10px solid transparent;
    }

    .tutorial-tooltip.tooltip-top::after {
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      border-top-color: white;
    }

    .tutorial-tooltip.tooltip-bottom::after {
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      border-bottom-color: white;
    }

    .tutorial-tooltip.tooltip-left::after {
      right: -20px;
      top: 50%;
      transform: translateY(-50%);
      border-left-color: white;
    }

    .tutorial-tooltip.tooltip-right::after {
      left: -20px;
      top: 50%;
      transform: translateY(-50%);
      border-right-color: white;
    }

    .tutorial-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .tutorial-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .tutorial-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tutorial-btn-primary {
      background-color: #2F7D31;
      color: white;
    }

    .tutorial-btn-primary:hover {
      background-color: #276629;
    }

    .tutorial-btn-secondary {
      background-color: #f3f4f6;
      color: #6b7280;
    }

    .tutorial-btn-secondary:hover {
      background-color: #e5e7eb;
    }

    .tutorial-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10004;
      text-align: center;
      max-width: 400px;
      font-family: 'Inter', sans-serif;
    }

    .tutorial-modal h2 {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 16px;
    }

    .tutorial-modal p {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .tutorial-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .tutorial-modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 100px;
    }

    .tutorial-modal-btn-primary {
      background-color: #2F7D31;
      color: white;
    }

    .tutorial-modal-btn-primary:hover {
      background-color: #276629;
    }

    .tutorial-modal-btn-secondary {
      background-color: #f3f4f6;
      color: #6b7280;
    }

    .tutorial-modal-btn-secondary:hover {
      background-color: #e5e7eb;
    }

    .tutorial-link {
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      margin-left: 16px;
      transition: color 0.2s;
    }

    .tutorial-link:hover {
      color: #2F7D31;
    }

    .tutorial-complete {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10004;
      text-align: center;
      max-width: 300px;
      font-family: 'Inter', sans-serif;
    }

    .tutorial-complete h2 {
      font-size: 24px;
      font-weight: 700;
      color: #2F7D31;
      margin-bottom: 16px;
    }

    .tutorial-complete p {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    .tutorial-complete-btn {
      padding: 12px 24px;
      background-color: #2F7D31;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tutorial-complete-btn:hover {
      background-color: #276629;
    }

    /* Responsive tutorial */
    @media (max-width: 768px) {
      .tutorial-tooltip {
        max-width: 250px;
        padding: 16px;
      }

      .tutorial-modal {
        margin: 20px;
        max-width: calc(100% - 40px);
      }

      .tutorial-complete {
        margin: 20px;
        max-width: calc(100% - 40px);
      }
    }
  </style>
</head>
<body>
  <!-- Tutorial System -->
  <div id="tutorialOverlay" class="tutorial-overlay">
    <div id="tutorialHighlight" class="tutorial-highlight"></div>
    <div id="tutorialTooltip" class="tutorial-tooltip">
      <div class="tutorial-text" id="tutorialText"></div>
      <div class="tutorial-buttons">
        <button id="tutorialSkip" class="tutorial-btn tutorial-btn-secondary">Skip Tutorial</button>
        <button id="tutorialNext" class="tutorial-btn tutorial-btn-primary">Next</button>
      </div>
    </div>
  </div>

  <div id="tutorialModal" class="tutorial-modal" style="display: none;">
    <h2>Welcome to Charity Stream!</h2>
    <p>Would you like a quick tutorial on how to use Charity Stream?</p>
    <div class="tutorial-modal-buttons">
      <button id="tutorialNo" class="tutorial-modal-btn tutorial-modal-btn-secondary">No</button>
      <button id="tutorialYes" class="tutorial-modal-btn tutorial-modal-btn-primary">Yes</button>
    </div>
  </div>

  <div id="tutorialComplete" class="tutorial-complete" style="display: none;">
    <h2>Tutorial Complete ðŸŽ‰</h2>
    <p>You're all set! Start watching ads and making a difference.</p>
    <button id="tutorialCompleteBtn" class="tutorial-complete-btn">Get Started</button>
  </div>

  <!-- Top Nav -->
  <header class="header">
      <div class="header-container">
        <a href="#" class="logo" id="logoBtn">Charity Stream</a>
        <a href="#" class="tutorial-link" id="tutorialLink">Tutorial</a>
      <nav class="nav">
        <div class="nav-hidden-mobile" id="loggedInNav" style="display: none;">
          <span class="welcome">Welcome, <span class="welcome-bold" id="usernameDisplay">User</span></span>
          <a href="/about.html" class="nav-link">About</a>
          <a href="/advertise.html" class="nav-link">Advertise</a>
          <a href="/impact.html" class="nav-link">Impact</a>
          <a href="#" class="watch-ads-btn" id="watchAdsBtn">Watch Ads</a>
        </div>
        <div class="nav-hidden-mobile" id="guestNav">
          <a href="/about.html" class="nav-link">About</a>
          <a href="/advertise.html" class="nav-link">Advertise</a>
          <a href="/impact.html" class="nav-link">Impact</a>
          <a href="#" class="watch-ads-btn" id="watchAdsBtn">Watch Ads</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- FORA Charity Header (shown when authenticated) -->
  <section class="frame-scaler frame-snap" id="framed-viewport">
    <div class="frame-inner">
      <section class="charity-header" id="charityHeader" style="display: none;">
        <div class="charity-header-container">
          <div class="charity-text">Your Donations This Week Support: <span class="charity-highlight">FORA â€” Empowering Refugee Families Through Education</span></div>
        </div>
      </section>
      
      <!-- Hero / Total Raised (shown when authenticated) -->
      <section class="hero" id="heroSection" style="display: none;">
        <div class="hero-container">
          <h1 class="hero-title">Total Raised for Charity</h1>
          <div class="hero-amount">$832.11</div>
          <p class="hero-subtitle">Stream ads, fuel impact, compete for good.</p>
        </div>
      </section>

  <!-- Lander Hero (shown when not authenticated) -->
  <section class="lander-hero" id="landerHero">
    <div class="lander-title-section">
      <h1 class="lander-title">Change Starts <span class="underline">Here</span></h1>
      <h2 class="lander-subtitle">Join the Stream.</h2>
    </div>
  </section>

      <!-- Main Content (shown when authenticated) -->
      <main class="main" id="mainContent" style="display: none;">
    <div class="grid">
      <!-- Video Area -->
      <section class="video-section">
        <div class="video-container">
          <div class="video-aspect">
            <video
              id="my-video"
              class="video-js vjs-default-skin"
              controls
              preload="auto"
              data-setup="{}"
            >
              <source src="videos/video1_1080p.mp4" type="video/mp4" />
              <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a
                web browser that supports HTML5 video.
              </p>
            </video>
            
            <!-- Login overlay for non-authenticated users -->
            <div class="login-overlay" id="loginOverlay">
              <div class="login-prompt">
                <h3>Sign In Required</h3>
                <p>Please sign in to start watching ads for charity and track your impact!</p>
                <button class="watch-ads-btn" onclick="goToAuth()">Sign In / Sign Up</button>
              </div>
            </div>
          </div>
        </div>
        <div class="video-controls">
          <div class="quality-text">Quality: <span class="quality-number" id="currentQualityDisplay">1080p</span></div>
          <button class="upgrade-btn" onclick="window.location.href='/subscribe.html'">Upgrade to get pop-out player</button>
        </div>
      </section>

      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Your Impact Card -->
        <div class="card">
          <div class="card-content">
            <h2 class="card-title">Your Impact</h2>
            <dl class="metrics">
              <div class="metric-row">
                <dt class="metric-label">Ads Watched Today</dt>
                <dd class="metric-value" id="adsWatchedToday">0</dd>
              </div>
              <div class="metric-row">
                <dt class="metric-label">Total Ads Watched</dt>
                <dd class="metric-value" id="totalAdsWatched">0</dd>
              </div>
              <div class="metric-row">
                <dt class="metric-label">Current Rank</dt>
                <dd class="metric-value" id="currentRank">#-</dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- Leaderboard Card -->
        <div class="card">
          <div class="card-content">
            <h2 class="card-title">Top Ad Watchers This Month</h2>
            <ul class="leaderboard">
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#1</span>
                  <span class="username">Branden4Good</span>
                </div>
                <span class="minutes">2,517 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#2</span>
                  <span class="username">HiMom11</span>
                </div>
                <span class="minutes">2,142 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#3</span>
                  <span class="username">AdsAreAwesome</span>
                </div>
                <span class="minutes">1,894 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#4</span>
                  <span class="username">Payit4Ward</span>
                </div>
                <span class="minutes">1,563 mins</span>
              </li>
              <li class="leaderboard-item">
                <div class="leaderboard-left">
                  <span class="rank">#5</span>
                  <span class="username">DrakeFan32</span>
                </div>
                <span class="minutes">1,244 mins</span>
              </li>
              <li class="leaderboard-item current-user" id="currentUserRow" style="display: none;">
                <div class="leaderboard-left">
                  <span class="rank current-user" id="userRankDisplay">#53</span>
                  <span class="username current-user"><span id="userLeaderboardName">You</span> (You)</span>
                </div>
                <span class="minutes current-user" id="userMinutesDisplay">0 mins</span>
              </li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
    
    <!-- Weekly Partner Progress Section -->
    <section class="progress-section">
      <div class="progress-content">
        <div class="progress-header">
          <div class="partner-text">Weekly Partner: Refugee FORA</div>
          <div class="progress-amount">
            <span class="amount-raised">$352</span> <span class="amount-text">raised of</span> <span class="amount-goal">$500</span> <span class="amount-text">goal</span>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill"></div>
        </div>
      </div>
    </section>
      </main>
    </div>
  </section>

  <!-- Lander Main Content (shown when not authenticated) -->
  <main class="lander-main" id="landerMain">
    <!-- Video Player -->
    <div class="lander-video-container" onclick="handlePlayButtonClick(event)">
      <div class="lander-play-button"></div>
    </div>
    
    <!-- Ticker Section -->
    <div class="lander-ticker-section">
      <!-- Top Ticker - Charities -->
      <div class="lander-ticker-container">
        <div class="lander-ticker lander-ticker-top">
          <div class="lander-ticker-chip">Habitat For Humanity +$125</div>
          <div class="lander-ticker-chip">Red Cross Foundation +$89</div>
          <div class="lander-ticker-chip">Save The Children +$156</div>
          <div class="lander-ticker-chip">World Wildlife Fund +$78</div>
          <div class="lander-ticker-chip">Doctors Without Borders +$203</div>
          <div class="lander-ticker-chip">United Way +$134</div>
          <div class="lander-ticker-chip">Feeding America +$98</div>
          <div class="lander-ticker-chip">American Cancer Society +$167</div>
          <div class="lander-ticker-chip">Habitat For Humanity +$125</div>
          <div class="lander-ticker-chip">Red Cross Foundation +$89</div>
          <div class="lander-ticker-chip">Save The Children +$156</div>
          <div class="lander-ticker-chip">World Wildlife Fund +$78</div>
          <div class="lander-ticker-chip">Doctors Without Borders +$203</div>
          <div class="lander-ticker-chip">United Way +$134</div>
          <div class="lander-ticker-chip">Feeding America +$98</div>
          <div class="lander-ticker-chip">American Cancer Society +$167</div>
        </div>
      </div>
      
      <!-- Bottom Ticker - Top Watchers -->
      <div class="lander-ticker-container">
        <div class="lander-ticker lander-ticker-bottom">
          <div class="lander-ticker-chip lander-ticker-chip-bottom">Money23: +23,428 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">StreamKing99: +18,567 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">CharityFan42: +15,890 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">WatcherPro: +14,223 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">GoodVibes88: +12,445 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">HelpingHands: +11,234 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">ViewForGood: +10,876 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">StreamLover: +9,654 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">Money23: +23,428 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">StreamKing99: +18,567 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">CharityFan42: +15,890 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">WatcherPro: +14,223 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">GoodVibes88: +12,445 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">HelpingHands: +11,234 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">ViewForGood: +10,876 min watched</div>
          <div class="lander-ticker-chip lander-ticker-chip-bottom">StreamLover: +9,654 min watched</div>
        </div>
      </div>
    </div>
  </main>

  <div class="loading" id="loadingIndicator">Loading...</div>

  <!-- Video.js -->
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  
  <!-- Custom scripts -->
  <script src="script.js"></script>
  
  <script>
    // Authentication and user management
    let currentUser = null;
    let authToken = null;
    let currentSessionId = null;
    let player = null;
    let isPlayerInitialized = false;

    // Check authentication immediately when script loads
    authToken = localStorage.getItem('authToken');
    const userStr = localStorage.getItem('currentUser');
    
    if (authToken && userStr) {
      try {
        currentUser = JSON.parse(userStr);
        console.log('ðŸ‘¤ Pre-loaded user data:', currentUser);
      } catch (error) {
        console.error('âŒ Error parsing cached user data:', error);
      }
    }

    // Set initial UI state immediately to prevent flash
    function setInitialUIState() {
      console.log('ðŸ”§ setInitialUIState called, authToken:', !!authToken);
      
      const loggedInNav = document.getElementById('loggedInNav');
      const guestNav = document.getElementById('guestNav');
      const watchAdsBtn = document.getElementById('watchAdsBtn');
      const charityHeader = document.getElementById('charityHeader');
      const heroSection = document.getElementById('heroSection');
      const landerHero = document.getElementById('landerHero');
      const mainContent = document.getElementById('mainContent');
      const landerMain = document.getElementById('landerMain');
      
      if (!authToken) {
        console.log('âŒ No auth token found, showing lander content');
        
        // Show lander content
        if (guestNav) guestNav.style.display = 'flex';
        if (loggedInNav) loggedInNav.style.display = 'none';
        if (watchAdsBtn) watchAdsBtn.style.display = 'none';
        if (charityHeader) charityHeader.style.display = 'none';
        if (landerHero) landerHero.style.display = 'block';
        if (heroSection) heroSection.style.display = 'none';
        if (landerMain) landerMain.style.display = 'flex';
        if (mainContent) mainContent.style.display = 'none';
        
        return;
      }
      
      // User is authenticated, show authenticated UI
      console.log('âœ… User authenticated, showing authenticated UI');
      
      const loginOverlay = document.getElementById('loginOverlay');
      const currentUserRow = document.getElementById('currentUserRow');
      
      console.log('ðŸ” Elements found:', {
        loggedInNav: !!loggedInNav,
        guestNav: !!guestNav,
        loginOverlay: !!loginOverlay,
        currentUserRow: !!currentUserRow,
        heroSection: !!heroSection,
        landerHero: !!landerHero,
        mainContent: !!mainContent,
        landerMain: !!landerMain
      });
      
      // Show authenticated content
      if (loggedInNav) loggedInNav.style.display = 'flex';
      if (guestNav) guestNav.style.display = 'none';
      if (watchAdsBtn) watchAdsBtn.style.display = 'inline-flex';
      if (charityHeader) charityHeader.style.display = 'block';
      if (heroSection) heroSection.style.display = 'block';
      if (landerHero) landerHero.style.display = 'none';
      if (mainContent) mainContent.style.display = 'block';
      if (landerMain) landerMain.style.display = 'none';
      if (loginOverlay) loginOverlay.style.display = 'none';
      if (currentUserRow) currentUserRow.style.display = 'flex';
      
      if (currentUser) {
        const displayName = currentUser.username || currentUser.email?.split('@')[0] || 'User';
        const usernameDisplay = document.getElementById('usernameDisplay');
        const userLeaderboardName = document.getElementById('userLeaderboardName');
        
        if (usernameDisplay) usernameDisplay.textContent = displayName;
        if (userLeaderboardName) userLeaderboardName.textContent = displayName;
        
        console.log('ðŸ‘¤ Set display name to:', displayName);
      }
    }

    // Call immediately when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setInitialUIState);
    } else {
      setInitialUIState();
    }

    // Logo button functionality
    document.addEventListener('DOMContentLoaded', function() {
      const logoBtn = document.getElementById('logoBtn');
      if (logoBtn) {
        logoBtn.onclick = function(e) {
          e.preventDefault();
          
          if (authToken) {
            // User is logged in, go to main page
            window.location.href = '/';
          } else {
            // User is not logged in, go to sign in
            window.location.href = '/auth.html';
          }
        };
      }

      // Watch Ads button functionality
      const watchAdsBtn = document.getElementById('watchAdsBtn');
      if (watchAdsBtn) {
        watchAdsBtn.onclick = function(e) {
          e.preventDefault();
          
          if (authToken) {
            // User is logged in, go to main page
            window.location.href = '/';
          } else {
            // User is not logged in, go to sign in
            window.location.href = '/auth.html';
          }
        };
      }
    });

    // Lander click handlers
    function handleWatchAdsClick(event) {
      event.preventDefault();
      // Redirect to sign in page
      window.location.href = '/auth.html';
    }

    function handlePlayButtonClick(event) {
      event.preventDefault();
      // Redirect to sign in page
      window.location.href = '/auth.html';
    }

    // Check authentication on page load
    window.onload = function() {
      console.log('ðŸš€ Page loading, checking authentication...');
      
      // Check for token from URL parameters (Google OAuth callback)
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      
      if (tokenFromUrl) {
        console.log('ðŸ”‘ Token found in URL, storing in localStorage');
        localStorage.setItem('authToken', tokenFromUrl);
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      authToken = localStorage.getItem('authToken');
      const userStr = localStorage.getItem('currentUser');
      
      console.log('ðŸ” Auth check:', {
        hasToken: !!authToken,
        hasUser: !!userStr,
        token: authToken ? 'Present' : 'Missing'
      });
      
      // UI state is already set by setInitialUIState()
      if (!authToken) {
        console.log('âŒ No auth token found in window.onload, lander content should be showing');
        
        // Ensure pop-up ads are deactivated for unauthenticated users
        if (popupAdManager) {
          popupAdManager.deactivate();
        }
        
        return;
      }
      
      // User is authenticated, initialize video player
      console.log('âœ… User has token, initializing authenticated video player...');
      
      // Initialize video player immediately (don't wait for loadUserInfo)
      initializeVideoPlayer();
      
      // Load fresh user info in background (non-blocking)
      loadUserInfo().catch(error => {
        console.log('User info loading failed (non-critical):', error);
      });
    };

    function showAuthenticatedUI() {
      document.getElementById('loggedInNav').style.display = 'flex';
      document.getElementById('guestNav').style.display = 'none';
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('currentUserRow').style.display = 'flex';
      
      // Username will be set by loadUserInfo() after it completes
      document.getElementById('usernameDisplay').textContent = 'Loading...';
      document.getElementById('userLeaderboardName').textContent = 'Loading...';
    }

    function showUnauthenticatedUI() {
      document.getElementById('loggedInNav').style.display = 'none';
      document.getElementById('guestNav').style.display = 'flex';
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('currentUserRow').style.display = 'none';
    }

    function goToAuth() {
      window.location.href = '/auth.html';
    }

    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      authToken = null;
      currentUser = null;
      
      // Deactivate pop-up ads when user logs out
      if (popupAdManager) {
        popupAdManager.deactivate();
      }
      
      showUnauthenticatedUI();
      
      // Reinitialize video player for guests
      if (player) {
        player.dispose();
        player = null;
        isPlayerInitialized = false;
      }
      setTimeout(initializeVideoPlayerForGuests, 50);
    }

    function handleNavClick(action) {
      const token = localStorage.getItem('authToken');
      
      if (!token) {
        // Redirect to login if not authenticated
        window.location.href = '/auth.html';
        return;
      }

      switch (action) {
        case 'about':
          window.location.href = '/about.html';
          break;
        case 'impact':
          window.location.href = '/impact.html';
          break;
        case 'watch':
          // Already on main page, scroll to top
          window.scrollTo({ top: 0, behavior: 'smooth' });
          break;
      }
    }

    function handleGuestNavClick(action) {
      switch (action) {
        case 'about':
          window.location.href = '/about.html';
          break;
        case 'impact':
          window.location.href = '/impact.html';
          break;
        case 'watch':
          window.location.href = '/auth.html';
          break;
      }
    }

    function handleWatchAdsClick(event) {
      event.preventDefault();
      
      // Check if user is authenticated
      if (authToken) {
        // User is authenticated, go to main page (ad watching section)
        window.location.href = '/';
      } else {
        // User is not authenticated, redirect to auth page
        window.location.href = '/auth.html';
      }
    }

    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const userMenu = document.querySelector('.user-menu');
      const dropdown = document.getElementById('userDropdown');
      
      if (userMenu && !userMenu.contains(event.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Load fresh user info from server
    async function loadUserInfo() {
      try {
        console.log('ðŸ“¡ Loading user info with token:', authToken ? 'Present' : 'Missing');
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        console.log('ðŸ“¡ User info response status:', response.status);
        if (response.ok) {
          const result = await response.json();
          console.log('ðŸ‘¤ User info received:', result);
          currentUser = result.user;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Update UI with user data
          const displayName = currentUser.username || currentUser.email?.split('@')[0] || 'User';
          document.getElementById('usernameDisplay').textContent = displayName;
          document.getElementById('userLeaderboardName').textContent = displayName;
          document.getElementById('totalAdsWatched').textContent = currentUser.totalMinutesWatched || 0;
          document.getElementById('userMinutesDisplay').textContent = '0 mins'; // Will be updated by loadUserImpact()
          
          // Load user impact and leaderboard data
          loadUserImpact();
          loadLeaderboard();
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    // Initialize video player for guests (no functionality)
    function initializeVideoPlayerForGuests() {
      // Prevent multiple initializations
      if (isPlayerInitialized) {
        console.log('ðŸŽ¬ Guest player already initialized, skipping...');
        return;
      }
      
      // Dispose any existing player
      if (player) {
        player.dispose();
        player = null;
        isPlayerInitialized = false;
      }
      
      // Wait for Video.js to be available
      if (typeof videojs === 'undefined') {
        setTimeout(initializeVideoPlayerForGuests, 50);
        return;
      }
      
      try {
        player = videojs('my-video', {
          controls: false,
          autoplay: false,
          preload: 'none',
          fluid: true
        });

        // Intercept play attempts and show login
        player.on('play', function(e) {
          e.preventDefault();
          player.pause();
          document.getElementById('loginOverlay').style.display = 'flex';
          return false;
        });

        // Also intercept the big play button click
        player.on('loadstart', function() {
          const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
          if (bigPlayButton) {
            bigPlayButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              document.getElementById('loginOverlay').style.display = 'flex';
              return false;
            });
          }
        });
        
        console.log('Guest video player initialized');
        isPlayerInitialized = true;
      } catch (error) {
        console.error('Error initializing guest video player:', error);
      }
    }

    // Start a watch session
    async function startWatchSession(videoName, quality) {
      if (!authToken) return null;

      try {
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

        const response = await fetch('/api/tracking/start-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            videoName: videoName,
            quality: quality
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (response.ok) {
          const result = await response.json();
          currentSessionId = result.sessionId;
          console.log('ðŸ“º Watch session started:', result.sessionId);
          return result.sessionId;
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          console.log('ðŸ“º Watch session request timed out (non-critical)');
        } else {
          console.error('Error starting watch session:', error);
        }
      }
      return null;
    }

    // Start ad tracking
    async function startAdTracking(sessionId) {
      if (!authToken || !sessionId) return null;

      try {
        const response = await fetch('/api/tracking/start-ad', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            sessionId: sessionId
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('ðŸ“º Ad tracking started:', result.adTrackingId);
          return result.adTrackingId;
        }
      } catch (error) {
        console.error('Error starting ad tracking:', error);
      }
      return null;
    }

    // Complete ad tracking
    async function completeAdTracking(adTrackingId, durationSeconds, completed = true) {
      if (!authToken || !adTrackingId) return;

      try {
        const response = await fetch('/api/tracking/complete-ad', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            adTrackingId: adTrackingId,
            durationSeconds: durationSeconds,
            completed: completed
          })
        });

        if (response.ok) {
          console.log('ðŸ“º Ad tracking completed:', durationSeconds, 'seconds');
          // Refresh user impact data and leaderboard
          loadUserImpact();
          loadLeaderboard();
        }
      } catch (error) {
        console.error('Error completing ad tracking:', error);
      }
    }

    // Load user impact data
    async function loadUserImpact() {
      if (!authToken) return;

      try {
        const response = await fetch('/api/user/impact', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          const impact = result.impact;
          
          // Update UI with impact data
          document.getElementById('adsWatchedToday').textContent = impact.adsWatchedToday;
          document.getElementById('totalAdsWatched').textContent = impact.totalAdsWatched;
          document.getElementById('currentRank').textContent = `#${impact.currentRank}`;
          document.getElementById('userMinutesDisplay').textContent = `${impact.watchTimeMinutes} mins`;
          document.getElementById('userRankDisplay').textContent = `#${impact.currentRank}`;
          
          console.log('ðŸ“Š User impact data loaded:', impact);
        }
      } catch (error) {
        console.error('Error loading user impact:', error);
      }
    }

    // Load leaderboard data
    async function loadLeaderboard() {
      if (!authToken) return;

      try {
        const response = await fetch('/api/leaderboard/monthly?limit=5', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          const leaderboard = result.leaderboard;
          
          // Update leaderboard UI
          const leaderboardContainer = document.querySelector('.leaderboard');
          if (leaderboardContainer) {
            // Clear existing items except the current user row
            const currentUserRow = document.getElementById('currentUserRow');
            leaderboardContainer.innerHTML = '';
            
            // Add leaderboard items
            leaderboard.forEach((user, index) => {
              const item = document.createElement('li');
              item.className = 'leaderboard-item';
              item.innerHTML = `
                <div class="leaderboard-left">
                  <span class="rank">#${user.rank}</span>
                  <span class="username">${user.username}</span>
                </div>
                <span class="minutes">${user.minutesWatched} mins</span>
              `;
              leaderboardContainer.appendChild(item);
            });
            
            // Add placeholder items if fewer than 5 users
            for (let i = leaderboard.length; i < 5; i++) {
              const item = document.createElement('li');
              item.className = 'leaderboard-item';
              item.innerHTML = `
                <div class="leaderboard-left">
                  <span class="rank">#${i + 1}</span>
                  <span class="username">Spot is open!</span>
                </div>
                <span class="minutes">0 mins</span>
              `;
              leaderboardContainer.appendChild(item);
            }
            
            // Add current user row if it exists
            if (currentUserRow) {
              leaderboardContainer.appendChild(currentUserRow);
            }
          }
          
          console.log('ðŸ† Leaderboard data loaded:', leaderboard);
        }
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // Initialize full video player functionality for authenticated users
    function initializeVideoPlayer() {
      if (!authToken) return;
      
      // Prevent multiple initializations
      if (isPlayerInitialized) {
        console.log('ðŸŽ¬ Player already initialized, skipping...');
        return;
      }

      console.log('ðŸŽ¬ Initializing authenticated video player...');

      // Dispose existing player if any
      if (player) {
        player.dispose();
        player = null;
        isPlayerInitialized = false;
      }
      
      // Wait for Video.js to be available with shorter timeout
      if (typeof videojs === 'undefined') {
        console.log('ðŸŽ¬ Video.js not ready, retrying in 50ms...');
        setTimeout(initializeVideoPlayer, 50);
        return;
      }
      
      try {
        player = videojs('my-video', {
          controls: true,
          autoplay: false,
          preload: 'auto',
          fluid: true,
          loop: false, // We'll handle looping manually
          controlBar: {
            progressControl: false,
            fullscreenToggle: false,
            pictureInPictureToggle: false,
            currentTimeDisplay: false,
            timeDivider: false,
            durationDisplay: false,
            remainingTimeDisplay: false,
            volumePanel: false,
            playbackRateMenuButton: false,
            chaptersButton: false,
            descriptionsButton: false,
            subtitlesButton: false,
            captionsButton: false,
            audioTrackButton: false
          }
        });

        const loadingIndicator = document.getElementById("loadingIndicator");
        const playlist = ["video1", "video2", "video3"];
        let currentIndex = 0;
        let currentQuality = "1080p";
        let isQualitySwitching = false;
        let sessionStartTime = null;
        let pausedCount = 0;
        let currentVideoStartTime = null;
        let isInitialLoad = true;
        let isPlaying = false;
        let currentAdTrackingId = null;
        let adStartTime = null;
        let isAdPlaying = false;
        let accumulatedAdTime = 0; // Track actual playback time

        function getVideoUrl(videoName, quality) {
          return `videos/${videoName}_${quality}.mp4`;
        }

        function getCurrentVideoSource() {
          const videoName = playlist[currentIndex];
          return {
            src: getVideoUrl(videoName, currentQuality),
            type: "video/mp4"
          };
        }

        function updateQualityDisplay() {
          document.getElementById('currentQualityDisplay').textContent = currentQuality;
        }

        function loadVideoWithQuality(index) {
          if (index >= playlist.length) {
            console.log(`âš ï¸ Index ${index} is out of bounds for playlist length ${playlist.length}`);
            return;
          }
          
          console.log(`ðŸŽ¬ loadVideoWithQuality called with index: ${index}`);
          console.log(`ðŸŽ¬ Current playlist:`, playlist);
          console.log(`ðŸŽ¬ Current quality:`, currentQuality);
          
          currentIndex = index;
          const source = getCurrentVideoSource();
          console.log(`ðŸŽ¬ Loading video ${index + 1} (${playlist[index]}): ${source.src}`);
          console.log(`ðŸŽ¬ Full video path: videos/${playlist[index]}_${currentQuality}.mp4`);
          
          // Add error handling for video loading
          player.src(source);
          updateQualityDisplay();
          
          // Set a timeout to check if video loaded successfully
          const loadTimeout = setTimeout(() => {
            if (player.readyState() === 0) {
              console.warn('Video failed to load, trying next video...');
              loadVideoWithQuality((index + 1) % playlist.length);
            }
          }, 5000);
          
          player.one('loadeddata', () => {
            clearTimeout(loadTimeout);
            console.log('âœ… Video loaded successfully');
            
            // Auto-play when video loads (both initial and subsequent videos)
            setTimeout(() => {
              console.log('ðŸŽ¬ Attempting to auto-play video...');
              player.play().catch(error => {
                console.log('Auto-play prevented:', error);
              });
            }, 100);
            
            // Mark initial load as complete
            if (isInitialLoad) {
              isInitialLoad = false;
            }
          });
          
          // Start watch session non-blocking (don't wait for it)
          if (typeof startWatchSession === 'function' && authToken) {
            startWatchSession(playlist[currentIndex], currentQuality).then(sessionId => {
              if (sessionId) {
                currentSessionId = sessionId;
                currentVideoStartTime = Date.now();
                sessionStartTime = null;
                pausedCount = 0;
                // Reset ad tracking state for new video
                isAdPlaying = false;
                currentAdTrackingId = null;
                adStartTime = null;
                accumulatedAdTime = 0;
                console.log('ðŸ“Š Watch session started:', sessionId);
              }
            }).catch(error => {
              console.log('ðŸ“Š Watch session failed to start (non-critical):', error);
            });
          }
        }

        function disableDoubleClickFullscreen() {
          player.off('dblclick');
          const videoEl = player.el();
          const videoElement = videoEl.querySelector('video');
          
          const preventDoubleClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸš« Double-click prevented');
            return false;
          };
          
          const preventRightClick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸš« Right-click prevented');
            return false;
          };
          
          // Prevent double-click on video player
          videoEl.addEventListener('dblclick', preventDoubleClick, true);
          if (videoElement) {
            videoElement.addEventListener('dblclick', preventDoubleClick, true);
          }
          
          // Prevent right-click context menu
          videoEl.addEventListener('contextmenu', preventRightClick, true);
          if (videoElement) {
            videoElement.addEventListener('contextmenu', preventRightClick, true);
          }
          
          // Disable fullscreen functionality
          player.requestFullscreen = function() {
            console.log('ðŸš« Fullscreen disabled');
            return Promise.resolve();
          };
          
          // Disable picture-in-picture
          if (videoElement && videoElement.requestPictureInPicture) {
            videoElement.requestPictureInPicture = function() {
              console.log('ðŸš« Picture-in-picture disabled');
              return Promise.resolve();
            };
          }
        }

        player.on('play', () => {
          isPlaying = true;
          console.log('â–¶ï¸ Video started playing');
          
          if (!sessionStartTime && currentSessionId) {
            sessionStartTime = Date.now();
            console.log('â–¶ï¸ Video started playing, tracking begins');
          }
          
          // Start ad tracking when video starts playing (only if not already tracking)
          if (currentSessionId && !isAdPlaying) {
            isAdPlaying = true;
            adStartTime = Date.now();
            startAdTracking(currentSessionId).then(adTrackingId => {
              currentAdTrackingId = adTrackingId;
              console.log('ðŸ“º Ad tracking started for video play');
            });
          } else if (isAdPlaying && currentAdTrackingId) {
            // Resume tracking the same ad (don't start a new one)
            console.log('ðŸ“º Ad tracking resumed (same ad)');
          }
          
          // Hide the big play button when playing - try multiple times to ensure it works
          const hidePlayButton = () => {
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton) {
              console.log('ðŸŽ¯ Hiding play button');
              bigPlayButton.style.display = 'none';
              bigPlayButton.style.visibility = 'hidden';
              bigPlayButton.style.opacity = '0';
              bigPlayButton.style.pointerEvents = 'none';
            }
          };
          
          // Try immediately and with delays
          hidePlayButton();
          setTimeout(hidePlayButton, 50);
          setTimeout(hidePlayButton, 100);
          setTimeout(hidePlayButton, 200);
          setTimeout(hidePlayButton, 500);
        });

        player.on('pause', () => {
          isPlaying = false;
          pausedCount++;
          console.log('â¸ï¸ Video paused, pause count:', pausedCount);
          
          // Accumulate actual playback time if ad was playing
          if (isAdPlaying && adStartTime) {
            const currentTime = player.currentTime() || 0;
            accumulatedAdTime = currentTime;
            console.log('ðŸ“º Ad tracking paused - Current video time:', Math.floor(currentTime), 'seconds');
          }
          
          // Don't complete ad tracking on pause - just pause the tracking
          // The ad is still playing, just paused
          console.log('ðŸ“º Ad tracking paused (not completed)');
          
          // Show the big play button when paused
          const showPlayButton = () => {
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton) {
              console.log('ðŸŽ¯ Showing play button');
              bigPlayButton.style.display = 'flex';
              bigPlayButton.style.visibility = 'visible';
              bigPlayButton.style.opacity = '1';
              bigPlayButton.style.pointerEvents = 'auto';
            }
          };
          
          showPlayButton();
          setTimeout(showPlayButton, 50);
          setTimeout(showPlayButton, 100);
        });

        // Show play button when clicking anywhere on the video while playing
        player.on('click', () => {
          if (isPlaying) {
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton) {
              console.log('ðŸŽ¯ Showing play button on click');
              bigPlayButton.style.display = 'flex';
              bigPlayButton.style.visibility = 'visible';
              bigPlayButton.style.opacity = '1';
              bigPlayButton.style.pointerEvents = 'auto';
            }
          }
        });

        player.on("ended", function () {
          console.log(`ðŸŽ¬ Video ${currentIndex + 1} (${playlist[currentIndex]}) ended, switching to next video...`);
          console.log(`ðŸŽ¬ Current player state:`, {
            readyState: player.readyState(),
            paused: player.paused(),
            ended: player.ended(),
            currentSrc: player.currentSrc()
          });
          
          // Complete ad tracking if ad was playing (only when video actually ends)
          if (isAdPlaying && currentAdTrackingId && adStartTime) {
            // Use the video's current time for accurate tracking (excludes loading/buffering time)
            const currentTime = player.currentTime() || 0;
            const adDurationSeconds = Math.floor(Math.max(currentTime, accumulatedAdTime));
            completeAdTracking(currentAdTrackingId, adDurationSeconds, true);
            isAdPlaying = false;
            currentAdTrackingId = null;
            adStartTime = null;
            accumulatedAdTime = 0;
            console.log('ðŸ“º Ad tracking completed on video end:', adDurationSeconds, 'seconds (actual video time)');
          }
          
          // Complete current session if exists
          if (!isQualitySwitching && currentSessionId && currentVideoStartTime) {
            const durationSeconds = Math.floor((Date.now() - currentVideoStartTime) / 1000);
            if (typeof completeWatchSession === 'function') {
              completeWatchSession(currentSessionId, durationSeconds, true, pausedCount);
            }
            
            currentVideoStartTime = null;
            sessionStartTime = null;
            pausedCount = 0;
            currentSessionId = null;
          }
          
          if (!isQualitySwitching) {
            // Move to next video in playlist
            const oldIndex = currentIndex;
            currentIndex = (currentIndex + 1) % playlist.length;
            console.log(`ðŸ”„ Switching from video ${oldIndex + 1} (${playlist[oldIndex]}) to video ${currentIndex + 1} (${playlist[currentIndex]})`);
            console.log(`ðŸ”„ Next video URL: videos/${playlist[currentIndex]}_${currentQuality}.mp4`);
            
            // Load the next video using the same method as initial load
            loadVideoWithQuality(currentIndex);
            
            // Start new session for the next video (non-blocking)
            if (authToken) {
              startWatchSession(playlist[currentIndex], currentQuality).then(sessionId => {
                currentSessionId = sessionId;
                currentVideoStartTime = Date.now();
                // Reset ad tracking state for new video
                isAdPlaying = false;
                currentAdTrackingId = null;
                adStartTime = null;
                accumulatedAdTime = 0;
                console.log('ðŸ“Š New session started for next video:', sessionId);
              }).catch(error => {
                console.log('ðŸ“Š New session failed to start (non-critical):', error);
              });
            }
          } else {
            console.log('âš ï¸ Quality switching in progress, skipping video switch');
          }
        });

        player.on("waiting", () => {
          if (!isQualitySwitching) {
            loadingIndicator.style.display = "block";
          }
        });

        player.on("playing", () => {
          loadingIndicator.style.display = "none";
        });

        player.on("error", function() {
          const error = player.error();
          console.error('Video error:', error);
          console.error('Current video should be:', getCurrentVideoSource().src);
          loadingIndicator.style.display = "none";
        });

        // Set up event handlers immediately after player creation
        console.log('=== AUTHENTICATED VIDEO PLAYER LOADED ===');
        disableDoubleClickFullscreen();
        
        // Set up play button behavior
        const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
        if (bigPlayButton) {
          bigPlayButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸŽ¯ Play button clicked - starting video');
            
            // Ensure smooth playback
            setTimeout(() => {
              player.play().catch(error => {
                console.log('Play button click prevented:', error);
              });
            }, 10);
          });
        }

        // Hide unwanted controls
        const progress = player.controlBar.progressControl;
        if (progress) progress.el().style.display = "none";
        const fullscreenBtn = player.controlBar.fullscreenToggle;
        if (fullscreenBtn) fullscreenBtn.el().style.display = "none";
        const pipBtn = player.controlBar.pictureInPictureToggle;
        if (pipBtn) pipBtn.el().style.display = "none";
        
        // Hide time displays
        const currentTimeDisplay = player.controlBar.currentTimeDisplay;
        if (currentTimeDisplay) currentTimeDisplay.el().style.display = "none";
        const durationDisplay = player.controlBar.durationDisplay;
        if (durationDisplay) durationDisplay.el().style.display = "none";
        const remainingTimeDisplay = player.controlBar.remainingTimeDisplay;
        if (remainingTimeDisplay) remainingTimeDisplay.el().style.display = "none";
        const timeDivider = player.controlBar.timeDivider;
        if (timeDivider) timeDivider.el().style.display = "none";

        // Add error handling for video loading
        player.on('loadstart', function() {
          console.log('Video loading started');
        });

        player.on('loadedmetadata', function() {
          console.log('Video metadata loaded');
        });

        player.on('loadeddata', function() {
          console.log('Video data loaded');
        });

        // Set up all event handlers immediately
        player.on("waiting", () => {
          if (!isQualitySwitching) {
            loadingIndicator.style.display = "block";
          }
        });

        player.on("playing", () => {
          loadingIndicator.style.display = "none";
        });

        player.on("error", function() {
          const error = player.error();
          console.error('Video error:', error);
          console.error('Current video should be:', getCurrentVideoSource().src);
          loadingIndicator.style.display = "none";
        });

        player.on('play', () => {
          isPlaying = true;
          console.log('â–¶ï¸ Video started playing');
          
          if (!sessionStartTime && currentSessionId) {
            sessionStartTime = Date.now();
            console.log('â–¶ï¸ Video started playing, tracking begins');
          }
          
          // Hide the big play button when playing
          const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
          if (bigPlayButton) {
            console.log('ðŸŽ¯ Hiding play button on play');
            bigPlayButton.style.display = 'none';
            bigPlayButton.style.visibility = 'hidden';
            bigPlayButton.style.opacity = '0';
            bigPlayButton.style.pointerEvents = 'none';
          }
        });

        player.on('pause', () => {
          isPlaying = false;
          console.log('â¸ï¸ Video paused');
          
          // Show the big play button when paused
          const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
          if (bigPlayButton) {
            console.log('ðŸŽ¯ Showing play button on pause');
            bigPlayButton.style.display = 'flex';
            bigPlayButton.style.visibility = 'visible';
            bigPlayButton.style.opacity = '1';
            bigPlayButton.style.pointerEvents = 'auto';
          }
        });

        // Show play button when clicking anywhere on the video while playing
        player.on('click', () => {
          if (isPlaying) {
            const bigPlayButton = player.el().querySelector('.vjs-big-play-button');
            if (bigPlayButton) {
              console.log('ðŸŽ¯ Showing play button on click');
              bigPlayButton.style.display = 'flex';
              bigPlayButton.style.visibility = 'visible';
              bigPlayButton.style.opacity = '1';
              bigPlayButton.style.pointerEvents = 'auto';
            }
          }
        });

        player.on("ended", function () {
          console.log(`ðŸŽ¬ Video ${currentIndex + 1} (${playlist[currentIndex]}) ended, switching to next video...`);
          console.log(`ðŸŽ¬ Current player state:`, {
            readyState: player.readyState(),
            paused: player.paused(),
            ended: player.ended(),
            currentSrc: player.currentSrc()
          });
          
          // Complete current session if exists
          if (!isQualitySwitching && currentSessionId && currentVideoStartTime) {
            const durationSeconds = Math.floor((Date.now() - currentVideoStartTime) / 1000);
            if (typeof completeWatchSession === 'function') {
              completeWatchSession(currentSessionId, durationSeconds, true, pausedCount);
            }
            
            currentVideoStartTime = null;
            sessionStartTime = null;
            pausedCount = 0;
            currentSessionId = null;
          }
          
          if (!isQualitySwitching) {
            // Move to next video in playlist
            const oldIndex = currentIndex;
            currentIndex = (currentIndex + 1) % playlist.length;
            console.log(`ðŸ”„ Switching from video ${oldIndex + 1} (${playlist[oldIndex]}) to video ${currentIndex + 1} (${playlist[currentIndex]})`);
            console.log(`ðŸ”„ Next video URL: videos/${playlist[currentIndex]}_${currentQuality}.mp4`);
            
            // Load the next video using the same method as initial load
            loadVideoWithQuality(currentIndex);
            
            // Start new session for the next video (non-blocking)
            if (authToken) {
              startWatchSession(playlist[currentIndex], currentQuality).then(sessionId => {
                currentSessionId = sessionId;
                currentVideoStartTime = Date.now();
                // Reset ad tracking state for new video
                isAdPlaying = false;
                currentAdTrackingId = null;
                adStartTime = null;
                accumulatedAdTime = 0;
                console.log('ðŸ“Š New session started for next video:', sessionId);
              }).catch(error => {
                console.log('ðŸ“Š New session failed to start (non-critical):', error);
              });
            }
          } else {
            console.log('âš ï¸ Quality switching in progress, skipping video switch');
          }
        });

        // Initialize first video immediately
        console.log('Video player fully initialized');
        isPlayerInitialized = true;
        loadVideoWithQuality(0);
        
        // Ensure play button is visible initially
        if (bigPlayButton) {
          bigPlayButton.style.display = 'flex';
        }

        console.log('Authenticated video player initialization complete!');
      } catch (error) {
        console.error('Error initializing authenticated video player:', error);
      }
    }

    // Viewport framing script
    (function() {
      if (!window.matchMedia || !window.matchMedia('(min-width:1024px)').matches) return;
      var scaler = document.getElementById('framed-viewport');
      if (!scaler) return;
      var inner = scaler.querySelector('.frame-inner');
      if (!inner) return;

      function fit() {
        // Reset, measure, then scale down if needed
        inner.style.transform = 'scale(1)';
        var H = inner.getBoundingClientRect().height;
        var vh = window.innerHeight;
        var s = Math.min(1, vh / H);
        inner.style.transform = 'scale(' + s + ')';
        scaler.style.height = (H * s) + 'px';
      }

      window.addEventListener('load', fit, { once: true });
      window.addEventListener('resize', fit);
      // In case fonts/assets shift layout slightly after load
      setTimeout(fit, 600);
    })();

    // Pop-up Ad System
    class PopupAdManager {
      constructor() {
        this.videoPlayer = null;
        this.activePopups = new Map(); // Map of popup IDs to popup objects
        this.nextPopupId = 1;
        this.maxPopups = 10;
        this.minPopups = 0;
        this.isActive = false; // Track if pop-ups should be active
        
        this.init();
      }

      init() {
        // Set up navigation cleanup
        window.addEventListener('beforeunload', () => {
          this.cleanup();
        });

        // Don't start scheduling pop-ups immediately - wait for authentication check
        console.log('ðŸ“¢ Pop-up ad manager initialized (waiting for authentication)');
      }

      // Method to activate pop-ups (called only for authenticated users)
      activate() {
        if (this.isActive) return;
        
        this.isActive = true;
        console.log('ðŸ“¢ Pop-up ads activated for authenticated user');
        
        // Start scheduling pop-ups with higher frequency
        this.scheduleNextPopup();
      }

      // Method to deactivate pop-ups (called when user logs out)
      deactivate() {
        this.isActive = false;
        this.cleanup();
        console.log('ðŸ“¢ Pop-up ads deactivated');
      }

      setVideoPlayer(player) {
        this.videoPlayer = player;
      }

      scheduleNextPopup() {
        // Only schedule if pop-ups are active (user is authenticated)
        if (!this.isActive) {
          console.log('ðŸ“¢ Pop-up scheduling skipped - not authenticated');
          return;
        }
        
        // Schedule next pop-up between 1-8 seconds (even more frequent)
        const delay = Math.random() * (8 - 1) + 1;
        console.log(`ðŸ“¢ Next pop-up scheduled in ${Math.round(delay)} seconds`);
        
        setTimeout(() => {
          this.showPopup();
        }, delay * 1000);
      }

      showPopup() {
        // Check if we've reached max popups
        if (this.activePopups.size >= this.maxPopups) {
          console.log('ðŸ“¢ Max popups reached, skipping');
          this.scheduleNextPopup();
          return;
        }

        // Check if video player exists and is not paused
        if (this.videoPlayer && this.videoPlayer.paused()) {
          console.log('ðŸ“¢ Video is paused, skipping pop-up');
          this.scheduleNextPopup();
          return;
        }

        // Create new popup
        const popupId = this.nextPopupId++;
        const popup = this.createPopup(popupId);
        
        console.log(`ðŸ“¢ Showing pop-up ad #${popupId}`);
        
        // Store popup reference
        this.activePopups.set(popupId, popup);
        
        // Position pop-up randomly but ensure it's fully visible
        this.positionPopup(popup.element);
        
        // Show pop-up
        popup.element.classList.add('show');
        popup.updateTimerDisplay();

        // Start countdown
        popup.timerInterval = setInterval(() => {
          popup.currentCountdown--;
          popup.updateTimerDisplay();

          if (popup.currentCountdown <= 0) {
            this.closePopup(popupId, true); // true = auto-close
          }
        }, 1000);

        // Schedule next pop-up
        this.scheduleNextPopup();
      }

      createPopup(id) {
        // Create popup element
        const popupElement = document.createElement('div');
        popupElement.className = 'popup-ad';
        popupElement.id = `popup-${id}`;
        
        // Create close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'popup-close-btn';
        closeBtn.innerHTML = 'Ã—';
        closeBtn.addEventListener('click', () => {
          this.closePopup(id);
        });
        
        // Create content
        const content = document.createElement('div');
        content.className = 'popup-content';
        
        const title = document.createElement('div');
        title.className = 'popup-title';
        title.textContent = 'Pop up ad';
        
        const timer = document.createElement('div');
        timer.className = 'popup-timer';
        timer.textContent = '15';
        
        const subtitle = document.createElement('div');
        subtitle.className = 'popup-subtitle';
        subtitle.textContent = 'seconds remaining';
        
        content.appendChild(title);
        content.appendChild(timer);
        content.appendChild(subtitle);
        
        popupElement.appendChild(closeBtn);
        popupElement.appendChild(content);
        
        // Add to page
        document.body.appendChild(popupElement);
        
        // Return popup object
        return {
          id: id,
          element: popupElement,
          timerElement: timer,
          currentCountdown: 15,
          timerInterval: null,
          updateTimerDisplay: function() {
            this.timerElement.textContent = this.currentCountdown;
          }
        };
      }

      positionPopup(popupElement) {
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const popupWidth = 384;
        const popupHeight = 384;

        // Calculate random position ensuring popup stays within viewport
        const maxX = Math.max(0, viewportWidth - popupWidth);
        const maxY = Math.max(0, viewportHeight - popupHeight);

        const randomX = Math.random() * maxX;
        const randomY = Math.random() * maxY;

        popupElement.style.left = `${randomX}px`;
        popupElement.style.top = `${randomY}px`;
      }

      closePopup(popupId, isAutoClose = false) {
        const popup = this.activePopups.get(popupId);
        if (!popup) return;

        console.log(`ðŸ“¢ Closing pop-up ad #${popupId} (${isAutoClose ? 'auto-close' : 'manual'})`);
        
        // Clear countdown timer
        if (popup.timerInterval) {
          clearInterval(popup.timerInterval);
        }

        // Remove from DOM
        popup.element.remove();
        
        // Remove from active popups
        this.activePopups.delete(popupId);

        // If auto-closed, pause the video
        if (isAutoClose && this.videoPlayer) {
          console.log('ðŸ“¢ Auto-closing pop-up, pausing video');
          this.videoPlayer.pause();
        }
      }

      cleanup() {
        console.log('ðŸ“¢ Cleaning up pop-up ad system');
        
        // Close all active popups
        for (const [popupId, popup] of this.activePopups) {
          if (popup.timerInterval) {
            clearInterval(popup.timerInterval);
          }
          popup.element.remove();
        }
        
        this.activePopups.clear();
      }

      // Public method to pause pop-ups (useful for debugging)
      pausePopups() {
        console.log('ðŸ“¢ Pop-up scheduling paused');
        // Note: This is a simplified pause - in a full implementation you'd want to store the timeout
      }

      // Public method to resume pop-ups
      resumePopups() {
        console.log('ðŸ“¢ Pop-up scheduling resumed');
        this.scheduleNextPopup();
      }

      // Get current popup count
      getPopupCount() {
        return this.activePopups.size;
      }
    }

    // Initialize pop-up ad manager
    const popupAdManager = new PopupAdManager();

    // Set up video player reference when it's initialized (only for authenticated users)
    let originalInitializeVideoPlayer = null;
    let originalInitializeVideoPlayerForGuests = null;

    // Override the video player initialization to set up pop-up ad manager
    function setupPopupAdWithPlayer() {
      // Only set up pop-up ads for authenticated users
      if (!authToken) {
        console.log('ðŸ“¢ Pop-up ads disabled - user not authenticated');
        popupAdManager.deactivate();
        return;
      }
      
      if (player && !popupAdManager.videoPlayer) {
        popupAdManager.setVideoPlayer(player);
        popupAdManager.activate(); // Activate pop-ups for authenticated users
        console.log('ðŸ“¢ Pop-up ad manager connected to video player and activated');
      }
    }

    // Hook into existing video player initialization
    const originalPlayerInit = initializeVideoPlayer;
    initializeVideoPlayer = function() {
      const result = originalPlayerInit.apply(this, arguments);
      
      // Set up pop-up ad manager after player is ready (only for authenticated users)
      if (authToken) {
        setTimeout(() => {
          setupPopupAdWithPlayer();
        }, 1000);
      }
      
      return result;
    };

    // Also hook into guest player initialization
    const originalGuestPlayerInit = initializeVideoPlayerForGuests;
    initializeVideoPlayerForGuests = function() {
      const result = originalGuestPlayerInit.apply(this, arguments);
      
      // Ensure pop-up ads are deactivated for guest users
      popupAdManager.deactivate();
      
      return result;
    };

    // Make popupAdManager globally available for debugging
    window.popupAdManager = popupAdManager;

    // Tutorial System
    class TutorialManager {
      constructor() {
        this.currentStep = 0;
        this.isActive = false;
        this.tutorialSteps = [
          {
            selector: '.video-js .vjs-big-play-button, .video-js .vjs-play-control',
            text: 'Simply click the play button and begin watching ads.',
            position: 'bottom'
          },
          {
            selector: '.hero-amount',
            text: 'Total money raised for charity. See the About page for more.',
            position: 'bottom'
          },
          {
            selector: '.sidebar .board-card:first-child',
            text: 'Track how many ads you watched today, your total ads watched, and your current rank.',
            position: 'left'
          },
          {
            selector: '.sidebar .board-card:last-child',
            text: 'The leaderboard for top ad watchers this month plus your current standing. Get to #1 by the end of the month and win XXX (reward TBD).',
            position: 'left'
          },
          {
            selector: '.upgrade-btn',
            text: 'Pay $1/month to get a pop-out player, no pop-ups, 1.25x speed, and 1080p quality!',
            position: 'top'
          },
          {
            selector: '.charity-progress',
            text: 'Our weekly charity partner progress bar.',
            position: 'top'
          },
          {
            selector: 'a[href="/about.html"]',
            text: 'Learn more about Charity Stream here.',
            position: 'bottom'
          },
          {
            selector: 'a[href="/advertise.html"]',
            text: 'To advertise with us, sign up here.',
            position: 'bottom'
          },
          {
            selector: 'a[href="/impact.html"]',
            text: 'Track your personal impact.',
            position: 'bottom'
          },
          {
            selector: '.watch-ads-btn',
            text: 'Click here anytime to return to this page.',
            position: 'bottom'
          }
        ];

        this.init();
      }

      init() {
        // Set up event listeners
        document.getElementById('tutorialLink').addEventListener('click', (e) => {
          e.preventDefault();
          this.startTutorial();
        });

        document.getElementById('tutorialYes').addEventListener('click', () => {
          this.hideModal();
          this.startTutorial();
        });

        document.getElementById('tutorialNo').addEventListener('click', () => {
          this.hideModal();
          this.markTutorialSeen();
        });

        document.getElementById('tutorialNext').addEventListener('click', () => {
          this.nextStep();
        });

        document.getElementById('tutorialSkip').addEventListener('click', () => {
          this.endTutorial();
        });

        document.getElementById('tutorialCompleteBtn').addEventListener('click', () => {
          this.hideComplete();
        });

        // Check if we should show the tutorial modal
        this.checkTutorialModal();
      }

      checkTutorialModal() {
        // Check if this is a new user who hasn't seen the tutorial
        const hasSeenTutorial = localStorage.getItem('charityStream_tutorialSeen');
        const isNewUser = localStorage.getItem('charityStream_newUser');
        
        if (isNewUser === 'true' && !hasSeenTutorial) {
          // Show modal after a short delay to let the page load
          setTimeout(() => {
            this.showModal();
          }, 1000);
        }
      }

      showModal() {
        document.getElementById('tutorialModal').style.display = 'block';
      }

      hideModal() {
        document.getElementById('tutorialModal').style.display = 'none';
      }

      hideComplete() {
        document.getElementById('tutorialComplete').style.display = 'none';
      }

      startTutorial() {
        this.isActive = true;
        this.currentStep = 0;
        document.getElementById('tutorialOverlay').classList.add('active');
        this.showStep();
      }

      showStep() {
        if (this.currentStep >= this.tutorialSteps.length) {
          this.endTutorial();
          return;
        }

        const step = this.tutorialSteps[this.currentStep];
        const element = document.querySelector(step.selector);

        if (!element) {
          console.warn(`Tutorial step ${this.currentStep}: Element not found for selector "${step.selector}"`);
          this.nextStep();
          return;
        }

        // Highlight the element
        this.highlightElement(element);
        
        // Show tooltip
        this.showTooltip(element, step.text, step.position);
      }

      highlightElement(element) {
        const highlight = document.getElementById('tutorialHighlight');
        const rect = element.getBoundingClientRect();
        
        highlight.style.left = `${rect.left - 3}px`;
        highlight.style.top = `${rect.top - 3}px`;
        highlight.style.width = `${rect.width + 6}px`;
        highlight.style.height = `${rect.height + 6}px`;
      }

      showTooltip(element, text, position) {
        const tooltip = document.getElementById('tutorialTooltip');
        const tooltipText = document.getElementById('tutorialText');
        const rect = element.getBoundingClientRect();
        
        tooltipText.textContent = text;
        
        // Remove existing position classes
        tooltip.classList.remove('tooltip-top', 'tooltip-bottom', 'tooltip-left', 'tooltip-right');
        tooltip.classList.add(`tooltip-${position}`);

        // Position tooltip
        let left, top;
        const tooltipRect = tooltip.getBoundingClientRect();
        
        switch (position) {
          case 'top':
            left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            top = rect.top - tooltipRect.height - 20;
            break;
          case 'bottom':
            left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            top = rect.bottom + 20;
            break;
          case 'left':
            left = rect.left - tooltipRect.width - 20;
            top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            break;
          case 'right':
            left = rect.right + 20;
            top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
            break;
        }

        // Ensure tooltip stays within viewport
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        if (left < 10) left = 10;
        if (left + tooltipRect.width > viewportWidth - 10) {
          left = viewportWidth - tooltipRect.width - 10;
        }
        if (top < 10) top = 10;
        if (top + tooltipRect.height > viewportHeight - 10) {
          top = viewportHeight - tooltipRect.height - 10;
        }

        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
      }

      nextStep() {
        this.currentStep++;
        this.showStep();
      }

      endTutorial() {
        this.isActive = false;
        document.getElementById('tutorialOverlay').classList.remove('active');
        this.markTutorialSeen();
        this.showComplete();
      }

      showComplete() {
        document.getElementById('tutorialComplete').style.display = 'block';
      }

      markTutorialSeen() {
        localStorage.setItem('charityStream_tutorialSeen', 'true');
        localStorage.removeItem('charityStream_newUser');
      }

      // Public method to reset tutorial (for testing)
      resetTutorial() {
        localStorage.removeItem('charityStream_tutorialSeen');
        localStorage.setItem('charityStream_newUser', 'true');
        console.log('Tutorial reset - will show on next page load');
      }
    }

    // Initialize tutorial manager
    const tutorialManager = new TutorialManager();

    // Make tutorial manager globally available for debugging
    window.tutorialManager = tutorialManager;

    // Check for new user status from URL parameters or other sources
    function checkNewUserStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const isNewUser = urlParams.get('newUser') === 'true' || 
                       urlParams.get('tutorial') === 'true' ||
                       localStorage.getItem('charityStream_newUser') === 'true';
      
      if (isNewUser) {
        localStorage.setItem('charityStream_newUser', 'true');
      }
    }

    // Run new user check on page load
    checkNewUserStatus();
  </script>
</body>
</html>